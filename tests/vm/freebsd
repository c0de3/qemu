#!/usr/bin/env python
#
# FreeBSD VM image
#
# Copyright (C) 2017 Red Hat Inc.
#
# Authors:
#  Fam Zheng <famz@redhat.com>
#
# This work is licensed under the terms of the GNU GPL, version 2.  See
# the COPYING file in the top-level directory.
#

import os
import sys
import logging
import subprocess
import tempfile
import time
import basevm

class FreeBSDVM(basevm.BaseVM):
    name = "freebsd"
    BUILD_SCRIPT = """
        set -e;
        cd $(mktemp -d /var/tmp/qemu-test.XXXXXX);
        tar -xf /dev/vtbd1;
        ./configure {configure_opts};
        gmake -j{jobs};
        gmake check;
    """

    def build_image(self, img, rebuild=False):
        if os.path.exists(img) and not rebuild:
            return
        cimg = self._download_with_cache("http://download.patchew.org/freebsd.img.xz")
        img_tmp_xz = img + ".tmp.xz"
        img_tmp = img + ".tmp"
        subprocess.check_call(["cp", "-f", cimg, img_tmp_xz])
        subprocess.check_call(["xz", "-df", img_tmp_xz])
        subprocess.check_call(["mv", img_tmp, img])

if __name__ == "__main__":
    sys.exit(basevm.main(FreeBSDVM))
