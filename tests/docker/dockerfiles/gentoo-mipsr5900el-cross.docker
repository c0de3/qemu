#
# Docker mipsel (r5900) cross-compiler target
#
# Using multi-stage builds, this image requires docker-17.05.0 or later.
# (See: https://github.com/gentoo/gentoo-docker-images)
#
# SPDX-License-Identifier: GPL-2.0-or-later

# name the portage image
FROM gentoo/portage:20201121 as portage

# image is based on stage3-amd64
FROM gentoo/stage3:latest

# copy the entire portage volume in
COPY --from=portage /var/db/repos/gentoo /var/db/repos/gentoo

MAINTAINER Philippe Mathieu-Daud√© <f4bug@amsat.org>

# set CROSSDEV_OVERLAY to /usr/local/portage-crossdev
RUN mkdir -p /usr/local/portage-crossdev/{profiles,metadata} && \
    echo 'crossdev' > /usr/local/portage-crossdev/profiles/repo_name && \
    echo 'masters = gentoo' > /usr/local/portage-crossdev/metadata/layout.conf && \
    chown -R portage:portage /usr/local/portage-crossdev && \
    mkdir -p /etc/portage/repos.conf
ADD crossdev.conf /etc/portage/repos.conf/crossdev.conf

RUN emerge -qv \
        dev-vcs/git ">=dev-libs/glib-2.0" \
        sys-devel/crossdev \
        sys-libs/zlib dev-lang/python

RUN crossdev -s4 -t mipsr5900el-unknown-linux-gnu

ENV QEMU_CONFIGURE_OPTS --cross-prefix=mipsr5900el-unknown-linux-gnu-
